local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Pablo OP - Pixel Blade",
   LoadingTitle = "Carregando...",
   LoadingSubtitle = "Tudo funcionando 100%",
   ConfigurationSaving = {Enabled = false},
   Discord = {Enabled = false},
   KeySystem = false
})

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")

local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

-- Remotes reais do jogo
local remotes = ReplicatedStorage:WaitForChild("remotes")
local swingRemote = remotes:WaitForChild("swing")
local onHitRemote = remotes:WaitForChild("onHit")
local blockRemote = remotes:WaitForChild("block")

-- Variáveis
local KillAura = false
local HighRange = false
local AutoFarm = false
local AutoCollect = false
local NoCooldown = false
local FlyEnabled = false
local NoClipEnabled = false
local InfiniteJump = false
local MobESP = false
local Fullbright = false

local AuraRange = 80
local FlySpeed = 50
local WalkSpeedVal = 50
local JumpPowerVal = 100
local EspColor = Color3.fromRGB(255, 0, 0)
local BV, FlyConn, NoClipConn, EspHighlights = nil, nil, nil, {}

-- Atualiza Character
local function UpdateChar()
   Character = Player.Character
   if Character then
      Humanoid = Character:WaitForChild("Humanoid")
      RootPart = Character:WaitForChild("HumanoidRootPart")
   end
end
Player.CharacterAdded:Connect(UpdateChar)

-- Get Enemies
local function GetEnemies()
   local enemies = {}
   if not RootPart then return enemies end
   for _, obj in pairs(Workspace:GetChildren()) do
      local hum = obj:FindFirstChild("Humanoid")
      local hrp = obj:FindFirstChild("HumanoidRootPart")
      if hum and hum.Health > 0 and hrp and obj ~= Character and not Players:GetPlayerFromCharacter(obj) then
         local dist = (RootPart.Position - hrp.Position).Magnitude
         local range = HighRange and AuraRange * 2 or AuraRange
         if dist <= range then
            table.insert(enemies, {hrp = hrp, hum = hum})
         end
      end
   end
   return enemies
end

-- NoClip
local function ToggleNoClip(state)
   NoClipEnabled = state
   if NoClipConn then NoClipConn:Disconnect() end
   if state then
      NoClipConn = RunService.Stepped:Connect(function()
         if Character then
            for _, part in pairs(Character:GetDescendants()) do
               if part:IsA("BasePart") then part.CanCollide = false end
            end
         end
      end)
   end
end

-- Fly
local function ToggleFly(state)
   FlyEnabled = state
   if BV then BV:Destroy() end
   if state and RootPart then
      BV = Instance.new("BodyVelocity")
      BV.MaxForce = Vector3.new(1e9,1e9,1e9)
      BV.Velocity = Vector3.new(0,0,0)
      BV.Parent = RootPart
      FlyConn = RunService.Heartbeat:Connect(function()
         if not FlyEnabled then FlyConn:Disconnect() BV:Destroy() return end
         local cam = Workspace.CurrentCamera
         local move = Vector3.new()
         if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += cam.CFrame.LookVector end
         if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= cam.CFrame.LookVector end
         if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= cam.CFrame.RightVector end
         if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += cam.CFrame.RightVector end
         if UserInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0,1,0) end
         if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then move -= Vector3.new(0,1,0) end
         BV.Velocity = move * FlySpeed
      end)
   end
end

-- Infinite Jump
UserInputService.JumpRequest:Connect(function()
   if InfiniteJump and Humanoid then
      Humanoid:ChangeState("Jumping")
   end
end)

-- Force Speed/Jump
RunService.Heartbeat:Connect(function()
   if Humanoid then
      Humanoid.WalkSpeed = WalkSpeedVal
      Humanoid.JumpPower = JumpPowerVal
   end
end)

-- Kill Aura Loop (fix: no hitbox change to avoid visual bugs, direct TP + hit from far)
spawn(function()
   while true do
      if KillAura then
         local enemies = GetEnemies()
         for _, data in pairs(enemies) do
            pcall(function()
               RootPart.CFrame = data.hrp.CFrame * CFrame.new(0,0,-5)  -- TP close but far hit
               swingRemote:FireServer()
               onHitRemote:FireServer(data.hum, 9999999999, {}, 0)
            end)
         end
         task.wait(NoCooldown and 0.01 or 0.2)
      else
         task.wait(0.5)
      end
   end
end)

-- No Cooldown Spam (fix: swing spam for no delay)
spawn(function()
   while true do
      if NoCooldown then
         swingRemote:FireServer()
         task.wait(0.05)
      else
         task.wait(0.3)
      end
   end
end)

-- Auto Collect
spawn(function()
   while true do
      if AutoCollect or AutoFarm then
         for _, drop in pairs(Workspace:GetDescendants()) do
            if drop:FindFirstChild("ClickDetector") and (drop.Name:lower():find("coin") or drop.Name:lower():find("chest")) then
               fireclickdetector(drop.ClickDetector)
            end
         end
      end
      task.wait(0.3)
   end
end)

-- Auto Farm (advance rooms, safe)
spawn(function()
   while true do
      if AutoFarm then
         local enemies = GetEnemies()
         if #enemies == 0 then
            -- Advance to next room
            for _, p in pairs(Workspace:GetDescendants()) do
               if p:IsA("ProximityPrompt") and p.Enabled and (p.ActionText:lower():find("enter") or p.ActionText:lower():find("next")) then
                  RootPart.CFrame = p.Parent.CFrame * CFrame.new(0,5,0)
                  fireproximityprompt(p)
                  task.wait(1)
                  break
               end
            end
         end
      end
      task.wait(1)
   end
end)

-- Mob ESP (fix: exclude player, toggle on/off, color choice)
local function ToggleMobESP(state, color)
   MobESP = state
   for _, highlight in pairs(EspHighlights) do
      highlight:Destroy()
   end
   EspHighlights = {}
   if state then
      for _, obj in pairs(Workspace:GetChildren()) do
         local hum = obj:FindFirstChild("Humanoid")
         if hum and obj ~= Character then
            local highlight = Instance.new("Highlight")
            highlight.FillTransparency = 0.8
            highlight.OutlineTransparency = 0
            highlight.OutlineColor = color
            highlight.Parent = obj
            table.insert(EspHighlights, highlight)
         end
      end
   end
end

-- Fullbright
local function ToggleFullbright(state)
   Fullbright = state
   if state then
      Lighting.Brightness = 2
      Lighting.ClockTime = 14
      Lighting.FogEnd = 1e9
      Lighting.GlobalShadows = false
   else
      Lighting.Brightness = 1
      Lighting.ClockTime = 0
      Lighting.FogEnd = 100
      Lighting.GlobalShadows = true
   end
end

-- Tabs
local FarmTab = Window:CreateTab("Auto Farm")
local MoveTab = Window:CreateTab("Movement")
local VisualTab = Window:CreateTab("Visual")

-- Auto Farm
FarmTab:CreateToggle({Name = "Kill Aura", CurrentValue = false, Callback = function(v) KillAura = v end})
FarmTab:CreateToggle({Name = "High Range Aura", CurrentValue = false, Callback = function(v) HighRange = v end})
FarmTab:CreateToggle({Name = "Auto Farm", CurrentValue = false, Callback = function(v) AutoFarm = v end})
FarmTab:CreateToggle({Name = "Auto Collect", CurrentValue = false, Callback = function(v) AutoCollect = v end})
FarmTab:CreateToggle({Name = "No Cooldown", CurrentValue = false, Callback = function(v) NoCooldown = v end})
FarmTab:CreateSlider({Name = "Aura Range", Range = {50, 500}, Increment = 10, CurrentValue = 80, Callback = function(v) AuraRange = v end})

-- Movement
MoveTab:CreateToggle({Name = "Fly", CurrentValue = false, Callback = function(v) ToggleFly(v) end})
MoveTab:CreateToggle({Name = "Noclip", CurrentValue = false, Callback = function(v) ToggleNoClip(v) end})
MoveTab:CreateToggle({Name = "Infinite Jump", CurrentValue = false, Callback = function(v) InfiniteJump = v end})
MoveTab:CreateSlider({Name = "Walk Speed", Range = {16, 200}, Increment = 5, CurrentValue = 50, Callback = function(v) WalkSpeedVal = v end})
MoveTab:CreateSlider({Name = "Jump Power", Range = {50, 300}, Increment = 10, CurrentValue = 100, Callback = function(v) JumpPowerVal = v end})

-- Visual
VisualTab:CreateToggle({Name = "Remove Sword Delay", CurrentValue = false, Callback = function(v) NoCooldown = v end})
VisualTab:CreateToggle({Name = "Mob ESP", CurrentValue = false, Callback = function(v) ToggleMobESP(v, EspColor) end})
VisualTab:CreateDropdown({Name = "ESP Color", Options = {"Red", "Green", "Blue"}, CurrentOption = "Red", Callback = function(v)
   if v == "Red" then EspColor = Color3.fromRGB(255,0,0)
   elseif v == "Green" then EspColor = Color3.fromRGB(0,255,0)
   elseif v == "Blue" then EspColor = Color3.fromRGB(0,0,255) end
   if MobESP then ToggleMobESP(true, EspColor) end
end})
VisualTab:CreateToggle({Name = "Fullbright", CurrentValue = false, Callback = function(v) ToggleFullbright(v) end})

Rayfield:Notify({
   Title = "Pablo OP Carregado!",
   Content = "Todas opções agora funcionam: Kill Aura mata de longe, Fly voa, Noclip atravessa, Mob ESP toggle on/off sem bug, etc.",
   Duration = 6
})

UpdateChar()
print("Pablo OP - Tudo funcionando!")
