local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
   Name = "Pablo OP - Pixel Blade (Fix Final)",
   LoadingTitle = "Carregando Pablo OP...",
   LoadingSubtitle = "Flutua Suave + Mata Rápido Todos (incluindo grandes)",
   ConfigurationSaving = {Enabled = false},
   Discord = {Enabled = false},
   KeySystem = false
})

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local Player = Players.LocalPlayer

local remotes = ReplicatedStorage:WaitForChild("remotes")
local useAbility = remotes:WaitForChild("useAbility")
local abilityHit = remotes:WaitForChild("abilityHit")

local Character = Player.Character or Player.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

local KillAura = false
local AutoFarm = false
local NoClipEnabled = false
local MobESP = false
local Fullbright = false

local AuraRange = 600
local FarmHeightOffset = 28          -- Alto o suficiente para não pular/deitar
local EspHighlights = {}
local NoClipConn
local BodyPos, BodyGyro

Player.CharacterAdded:Connect(function(c)
   Character = c
   Humanoid = c:WaitForChild("Humanoid")
   RootPart = c:WaitForChild("HumanoidRootPart")
   if NoClipEnabled then ToggleNoClip(true) end
   if AutoFarm then SetupFloat() end
end)

local function SetupFloat()
   if BodyPos then BodyPos:Destroy() end
   if BodyGyro then BodyGyro:Destroy() end
   
   BodyPos = Instance.new("BodyPosition")
   BodyPos.MaxForce = Vector3.new(1e5, 1e5, 1e5)
   BodyPos.P = 15000
   BodyPos.D = 1000
   BodyPos.Parent = RootPart
   
   BodyGyro = Instance.new("BodyGyro")
   BodyGyro.MaxTorque = Vector3.new(4e5, 4e5, 4e5)
   BodyGyro.P = 20000
   BodyGyro.Parent = RootPart
end

local function UpdateFloat(targetPos)
   if BodyPos and BodyGyro and targetPos then
      BodyPos.Position = targetPos + Vector3.new(0, FarmHeightOffset, 0)
      BodyGyro.CFrame = CFrame.new(RootPart.Position, targetPos) * CFrame.Angles(0, math.rad(180), 0)  -- Olha para o mob, fica reto
   end
end

local function ToggleNoClip(state)
   NoClipEnabled = state
   if NoClipConn then NoClipConn:Disconnect() end
   if state then
      NoClipConn = RunService.Stepped:Connect(function()
         if Character then
            for _, p in ipairs(Character:GetDescendants()) do
               if p:IsA("BasePart") then p.CanCollide = false end
            end
         end
      end)
   end
end

local function IsValidEnemy(obj)
   if not obj:IsA("Model") then return false end
   local hum = obj:FindFirstChildWhichIsA("Humanoid")
   local hrp = obj:FindFirstChild("HumanoidRootPart")
   if not hum or not hrp or hum.Health <= 0 then return false end
   if Players:GetPlayerFromCharacter(obj) then return false end
   
   local n = obj.Name:lower()
   if n:find("plant") or n:find("trap") or n:find("spike") or n:find("vine") or n:find("dummy") then return false end
   
   -- Relaxado para pegar bosses/maiores
   return true  -- Removido filtro rígido para incluir monstros grandes
end

local function GetClosestEnemy()
   local closest, minDist = nil, AuraRange
   local rootPos = RootPart.Position
   for _, obj in ipairs(Workspace:GetChildren()) do
      if IsValidEnemy(obj) then
         local hrp = obj:FindFirstChild("HumanoidRootPart")
         local dist = (rootPos - hrp.Position).Magnitude
         if dist < minDist then
            minDist = dist
            closest = obj
         end
      end
   end
   return closest
end

local function HasEnemies()
   for _, obj in ipairs(Workspace:GetChildren()) do
      if IsValidEnemy(obj) then return true end
   end
   return false
end

local function AdvanceRoom()
   task.wait(0.6)  -- Mais tempo para carregar
   for _, obj in ipairs(Workspace:GetDescendants()) do
      if obj:IsA("ProximityPrompt") and obj.Enabled then
         local txt = obj.ActionText:lower()
         if txt:find("enter") or txt:find("next") or txt:find("portal") or txt:find("exit") or txt:find("continue") then
            RootPart.CFrame = obj.Parent.CFrame + Vector3.new(0, 10, 0)
            fireproximityprompt(obj)
            task.wait(2)
            return
         end
      end
   end
   -- Backup ExitZone
   for _, v in ipairs(Workspace:GetChildren()) do
      if v:FindFirstChild("ExitZone") then
         RootPart.CFrame = v.ExitZone.CFrame + Vector3.new(0, 15, 0)
         task.wait(1.5)
         return
      end
   end
end

-- Loop principal
local lastHitTime = 0
RunService.Heartbeat:Connect(function()
   if not Character or not RootPart or Humanoid.Health <= 0 then return end
   
   if AutoFarm then
      ToggleNoClip(true)
      SetupFloat()
   end
   
   local target = GetClosestEnemy()
   
   if AutoFarm and target then
      local targetHRP = target:FindFirstChild("HumanoidRootPart")
      if targetHRP then
         UpdateFloat(targetHRP.Position)  -- Flutua suave
      end
   elseif AutoFarm and not target then
      BodyPos.Position = RootPart.Position  -- Para de flutuar quando sem alvo
   end
   
   if (KillAura or AutoFarm) and tick() - lastHitTime > 0.04 then  -- Mais rápido
      lastHitTime = tick()
      useAbility:FireServer("tornado")
      
      local hitCount = 0
      for _, obj in ipairs(Workspace:GetChildren()) do
         if hitCount >= 80 then break end  -- Limite para FPS
         if IsValidEnemy(obj) then
            local hum = obj:FindFirstChildWhichIsA("Humanoid")
            if hum then
               abilityHit:FireServer(hum, math.huge, {["stun"] = {["dur"] = 0.8}})
               hitCount = hitCount + 1
            end
         end
      end
   end
   
   if AutoFarm and not HasEnemies() then
      task.spawn(AdvanceRoom)
   end
end)

local function ToggleMobESP(state)
   MobESP = state
   for _, h in ipairs(EspHighlights) do h:Destroy() end
   EspHighlights = {}
   if state then
      RunService.Heartbeat:Connect(function()
         if not MobESP then return end
         for _, obj in ipairs(Workspace:GetChildren()) do
            if IsValidEnemy(obj) and not obj:FindFirstChild("ESP") then
               local hl = Instance.new("Highlight")
               hl.Name = "ESP"
               hl.FillTransparency = 0.5
               hl.OutlineColor = Color3.fromRGB(255,0,0)
               hl.Parent = obj
               table.insert(EspHighlights, hl)
            end
         end
      end)
   end
end

local function ToggleFullbright(state)
   Fullbright = state
   if state then
      Lighting.Brightness = 3
      Lighting.ClockTime = 14
      Lighting.FogEnd = 1e9
      Lighting.GlobalShadows = false
   else
      Lighting.Brightness = 1
      Lighting.ClockTime = 0
      Lighting.FogEnd = 100
      Lighting.GlobalShadows = true
   end
end

-- Tabs
local FarmTab = Window:CreateTab("Farm")
local VisualTab = Window:CreateTab("Visual")

FarmTab:CreateToggle({Name = "Kill Aura (Mata Tudo Rápido)", Callback = function(v) KillAura = v end})
FarmTab:CreateToggle({Name = "Auto Farm (Flutua Suave + Avança)", Callback = function(v) 
   AutoFarm = v 
   if v then 
      KillAura = true 
      ToggleNoClip(true) 
      SetupFloat() 
   end 
end})

VisualTab:CreateToggle({Name = "Mob ESP", Callback = ToggleMobESP})
VisualTab:CreateToggle({Name = "Fullbright", Callback = ToggleFullbright})

Rayfield:Notify({
   Title = "Pablo OP Corrigido Final!",
   Content = "Flutuação suave com BodyPosition + BodyGyro (sem pular/deitar). Mata todos (incluindo grandes/bosses) mais rápido. Teleporte só para portal quando sala limpa. Teste agora!",
   Duration = 10
})

print("Pablo OP - Completo! Flutua suave, mata rápido todos os mobs, sem bugs.")
